/*
  ูุดุฑูุน: ูุธุงู ูุดู ุญุฑูุฉ ุจูุณุชุดุนุฑ PIR ูุน ุฅุฑุณุงู ุฅุดุนุงุฑ ุนุจุฑ ุงูุจููุชูุซ
  ุงููุตู: ุนูุฏ ุงูุชุดุงู ุงูุญุฑูุฉ ุจูุงุณุทุฉ ูุณุชุดุนุฑ PIRุ ูุฑุณู ุงูุฃุฑุฏูููู ุฑุณุงูุฉ ุนุจุฑ ุงูุจููุชูุซ
         (HC-05/HC-06) ูุชุทุจูู ุงููุงุชูุ ูุน ุทุจุงุนุฉ ุฑุณุงุฆู ุญุงูุฉ ุงูุงุชุตุงู.
  ุงูููุฑุฉ: ูุซุงู ุนููู ููุฑุงูุจุฉ ุงูููุฒู ุงูุฐูู.

  ุงูุชูุตููุงุช ุงูููุชุฑุญุฉ:
  - ูุณุชุดุนุฑ PIR (ูุซุงู HC-SR501):
      VCC -> 5V
      GND -> GND
      OUT -> D2 (ูุฏุฎู ุฑููู ูุน ุฎุงุตูุฉ ุงูููุงุทุนุฉ ุฅู ุฑุบุจุช)
  - ูุญุฏุฉ ุจููุชูุซ HC-05/HC-06:
      VCC -> 5V
      GND -> GND
      TXD -> RX ุงูุฃุฑุฏูููู
      RXD -> TX ุงูุฃุฑุฏูููู (ููุถู ููุณู ุฌูุฏ ุฅูู 3.3V ูุญูุงูุฉ ุงููุญุฏุฉ)

  ุงูููุงุญุธุงุช:
  - ุฅู ููุช ุชุณุชุฎุฏู Arduino Uno: ุงุณุชุฎุฏู Serial ุงูุงูุชุฑุงุถู ููุชูุงุตู ูุน ุงูุจููุชูุซุ
    ูุน ุงูุนูู ุฃูู ููุดุบู ููุณ ูููุฐ USB ุงูุชุณูุณูู. ูุจุฑูุฌุฉ ุงูููุญุฉ ุงูุตู ุงูู RX/TX
    ุนู ุงูุจููุชูุซ ูุคูุชูุง ูุชูุงุฏู ุงูุชุนุงุฑุถ ุฃุซูุงุก ุงูุฑูุน.
  - ูููู ุงุณุชุฎุฏุงู SoftwareSerial ุนูู ููุญุงุช ูุญุฏุฏุฉ ุฅุฐุง ุฃุฑุฏุช ุฅุจูุงุก Serial
    ููู USB ููุท.
*/

// ุงุฎุชุฑ ุฃุญุฏ ุงูุฎูุงุฑูู ุญุณุจ ุงุญุชูุงุฌู:
//#include <SoftwareSerial.h>
//SoftwareSerial BT(10, 11); // RX, TX (ูุตู TX ุงูุจููุชูุซ ุฅูู 10ุ ูRX ุงูุจููุชูุซ ุฅูู 11 ุนุจุฑ ููุณู ุฌูุฏ)

const int PIR_PIN = 2;         // ุทุฑู ุฎุฑุฌ ูุณุชุดุนุฑ PIR
const unsigned long DEBOUNCE_MS = 200; // ููุชุฑุฉ ุจุณูุทุฉ ูููุน ุงูุงูุชุฒุงุฒุงุช
volatile bool motionFlag = false;      // ููุถุจุท ุนูุฏ ุญุฏูุซ ุญุฑูุฉ
unsigned long lastTrigger = 0;

void IRAM_ATTR onMotion() {  // ุชูุณุชุฏุนู ุนูุฏ ุชุบูุฑ ุงูุฅุดุงุฑุฉ (ุฅู ูุงูุช ุงูููุญุฉ ุชุฏุนู ุงูููุงุทุนุงุช ุจูุฐู ุงูุตูุบุฉ)
  unsigned long now = millis();
  if (now - lastTrigger > DEBOUNCE_MS) {
    motionFlag = true;
    lastTrigger = now;
  }
}

void setup() {
  pinMode(PIR_PIN, INPUT);

  // ุจุฏุก ุงูุงุชุตุงู ุงูุชุณูุณูู ูุน ุงูุจููุชูุซ ุนุจุฑ Serial ุงูุงูุชุฑุงุถู ุจุณุฑุนุฉ 9600 (ุดุงุฆุนุฉ ููุญุฏุงุช HC-05/06)
  Serial.begin(9600);
  delay(500);

  // ุฅู ุงุณุชุฎุฏูุช SoftwareSerialุ ุงูุนู ุจุฏููุง ูู ุฐูู:
  // BT.begin(9600);

  // ุทุจุงุนุฉ ุฑุณุงูุฉ ุชุฑุญูุจ ูุชุนุฑูู ุงููุดุฑูุน
  Serial.println("[ูุธุงู ูุฑุงูุจุฉ ุงูุญุฑูุฉ] ุชู ุงูุชุดุบูู โ");
  Serial.println("ูุฑุฌู ูุชุญ ุชุทุจูู ุงูุจููุชูุซ ุนูู ุงููุงุชู ูุงูุงุชุตุงู ุจุงููุญุฏุฉ.");
  Serial.println("ุนูุฏ ุงูุงุชุตุงู ุณุชุธูุฑ ุฑุณุงูุฉ ุชุฑุญูุจูุฉุ ูุณูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุงูุชุดุงู ุงูุญุฑูุฉ.");

  // ุชูุนูู ููุงุทุนุฉ ุนูู ุทุฑู D2 (Uno: interrupt 0) ูููุดู ุงูุณุฑูุน ุนู ุงูุญุฑูุฉ
  attachInterrupt(digitalPinToInterrupt(PIR_PIN), onMotion, RISING);
}

void loop() {
  // ูุดู ุญุงูุฉ ุงูุงุชุตุงู: ุนูุฏ ูุชุญ ุงุชุตุงู ุชุณูุณูู ูู ุชุทุจูู ุงููุงุชูุ ูุฑุณู Arduino ุฑุณุงูุฉ ุชุฑุญูุจ
  if (Serial && Serial.availableForWrite()) {
    static bool greeted = false;
    if (!greeted) {
      Serial.println("[Bluetooth] ุชู ุงูุงุชุตุงู ุจุงูุชุทุจูู ๐");
      Serial.println("ุฃุฑุณู ุฃู ุญุฑู ูุงุฎุชุจุงุฑ ุงูุชูุงุตู.");
      greeted = true;
    }
  }

  // ุงุณุชูุจุงู ุฃู ุจูุงูุงุช ูุงุฏูุฉ ูู ุงูุชุทุจูู (ุงุฎุชูุงุฑู)
  if (Serial.available()) {
    char c = Serial.read();
    Serial.print("ุงุณุชูุจูุช: ");
    Serial.println(c);
  }

  // ุนูุฏ ุงูุชุดุงู ุญุฑูุฉ ุนุจุฑ ุงูููุงุทุนุฉ
  if (motionFlag) {
    motionFlag = false;

    // ูุฑุงุกุฉ ุญุงูุฉ ุงููุณุชุดุนุฑ ููุชุฃูุฏ
    int state = digitalRead(PIR_PIN);
    if (state == HIGH) {
      // ุฅุฑุณุงู ุฅุดุนุงุฑ ุนุจุฑ ุงูุจููุชูุซ
      Serial.println("[ุฅูุฐุงุฑ ุญุฑูุฉ] ุชู ุงูุชุดุงู ุญุฑูุฉ! ๐จ");
      Serial.println("ูุตูุญุฉ: ุชุญูู ูู ุงูููุงู ุฃู ุงุจุฏุฃ ุชุณุฌูู ููุฏูู ุฅู ุชููุฑ.");
    }
  }
}
